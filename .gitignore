from fastapi import FastAPI
from pydantic import BaseModel
import joblib
import pandas as pd

from ai_decision_engine import get_emergency_guidance

# -----------------------
# App init
# -----------------------
app = FastAPI(title="AI Critical Minutes API")

# Load model
model = joblib.load("models/emergency_risk_model.joblib")


# -----------------------
# Input schema
# -----------------------
class VitalsInput(BaseModel):
    age: int
    heart_rate: int
    systolic_bp: int
    diastolic_bp: int
    spo2: int
    respiration_rate: int
    body_temp: float
    blood_sugar: int


# -----------------------
# Prediction endpoint
# -----------------------
@app.post("/predict")
def predict_emergency(vitals: VitalsInput):
    # Convert input to DataFrame
    input_df = pd.DataFrame([vitals.dict()])

    # Predict risk
    risk_level = int(model.predict(input_df)[0])

    # AI guidance
    guidance = get_emergency_guidance(risk_level)

    return {
        "predicted_risk_level": risk_level,
        "guidance": guidance
    }
